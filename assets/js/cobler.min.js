function cobler(e){this.clear=function(){this.deselect();$("#cb-content").empty();this.slices=[];this.$el.find("#cb-starter").remove();this.$el.find("#cb-content").remove();if(this.options.editable){this.$el.append(Berry.render("cobler_init_cobler",this,e));$("#cb-content").sortable({cursor:"move",items:"li:not(.locked)",placeholder:"cb-placeholder",forcePlaceholderSize:true,axis:this.options.axis,start:function(e,t){$(".cb-placeholder").attr("data-name",$(t.item[0]).attr("data-name")).addClass($(t.item[0]).attr("class"))},stop:$.proxy(function(e,t){this.slices.splice($(t.item).index(),0,this.slices.splice(i($(t.item).attr("id")),1)[0]);cobler.changed=true;this.trigger("change")},this),cancel:"#cb-content li .cobler-li-content, #cb-content li.locked",receive:function(e,t){u=null}})}else{this.$el.append(Formal.render("cobler_init_cobler_noedit",this,e))}};this.reload=function(){var e=this.toJSON();this.clear();this.load(e)};this.load=function(e){this.clear();for(var t in e){$("#cb-starter").hide();var n=new cobler.types[e[t].widgetType](this,e[t]);if(n.validate(e[t],false)){$(n.createEL()).appendTo("#cb-content");this.slices.push(n)}if(n.callback){n.callback.call(n)}}};this.toJSON=function(e){var e=$.extend({},this.options,e);if(e.associative){json={};for(var t in this.slices){json[this.slices[t].uuid]=this.slices[t].attributes}return json}else{json=[];for(var t in this.slices){json.push(this.slices[t].attributes)}return json}};this.toHTML=function(e){var t=$("<div/>");for(var n in this.slices){t.append(this.slices[n].$el.find(".cobler-li-content").html())}return t.html()};this.add=function(e,n){var r=new cobler.types[e](this,n);if(r.validate(r.defaults,false)){this.slices.push(r);t(r.createEL().appendTo("#cb-content").hide().show("highlight"));$("#cb-starter").hide()}};this.updateWidget=function(e){cobler.changed=true;this.trigger("change");if(this.selected){this.selected.toJSON();if(e.force==true||this.form.find(e.path).force==true||this.selected.contentFields!==true){if(s.selected.editView){this.selected.$el.find(".cobler-li-content").html(this.selected.editView())}else{this.selected.$el.replaceWith($(this.selected.createEL()).addClass("selected"))}}if(this.selected.callback){this.selected.callback.call(this.selected)}}};this.deselect=function(){if(s.selected){if(this.form){this.updateWidget({force:true});this.form.destroy();this.form=false;s.selected.blur()}if(s.selected){s.selected.$el.removeClass("selected");s.selected=false}this.trigger("editComplete")}};this.remove=function(e){var t=r(e)||this.selected;if(t.$el.hasClass("selected")){this.deselect()}if(t){t.$el.fadeOut("fast",function(){this.remove();$("#cb-starter").toggle($("#cb-content > li").length===0)});t.remove();this.slices.splice(i(t.uuid),1)}};this.duplicate=function(e){var n=r(e)||this.selected;var i=new cobler.types[n.attributes.widgetType](this,$.extend(true,{},n.attributes));if(i.validate(i.attributes,false)){this.slices.push(i);t(i.createEL().insertAfter(n.$el).hide().show("highlight"))}if(i.callback){i.callback.call(i)}};this.addTypeDisplay=function(e){if(this.options.types==="all"||$.inArray(e.category,this.options.types)>-1){$(Berry.render("cobler_widget_cobler",e)).appendTo("#cb-source")}};var t=function(e){if(!$(e).hasClass("selected")){s.deselect();s.selected=r($(e).attr("id"));s.selected.$el.addClass("selected");if(s.options.autoedit){n(e)}}};var n=function(e){if(s.form){s.form.destroy();s.form=false}if(s.selected.editView){s.selected.$el.find(".cobler-li-content").html(s.selected.editView())}s.form=$("#cb-form").show().berry(r($(e).attr("id")).toFORM());s.form.on("change",$.proxy(s.updateWidget,s));s.trigger("edit")};var r=function(e){for(var t in s.slices){if(s.slices[t].uuid==e){return s.slices[t]}}return false};var i=function(e){for(var t in s.slices){if(s.slices[t].uuid==e){return t}}return false};this.options=$.extend({name:Berry.getUID(),types:"all",target:"#content",axis:"",form:"#alt-sidebar",source:"#alt-sidebar",autoedit:true,associative:false,editable:true,activeFormClass:"active"},e);var s=this;this.selected=false;this.form=false;this.slices=[];this.$el=$(this.options.target);this.clear();$(this.options.form).empty();$(this.options.source).empty();if($("#cb-source").length===0){$(this.options.source).append(Berry.render("cobler_controls_cobler",e));for(var o in cobler.types){this.addTypeDisplay(cobler.types[o].prototype)}}$(this.options.target).off("click","#cb-content li span.remove-item");$(this.options.target).on("click","#cb-content li span.remove-item",$.proxy(function(e){e.stopPropagation();this.remove($(e.target).parents("li").attr("id"))},this));$("body").off("click","#removeactive");$(this.options.source).on("click","#removeactive",$.proxy(function(e){e.stopPropagation();if(this.selected){this.remove(this.selected.uuid)}},this));$(this.options.target).off("click","#cb-content li span.duplicate-item");$(this.options.target).on("click","#cb-content li span.duplicate-item",$.proxy(function(e){e.stopPropagation();this.duplicate($(e.target).parents("li").attr("id"))},this));$(this.options.target).off("click","#cb-content > li");$(this.options.source).off("click","#cb-source > li");if(this.options.editable){$(this.options.target).on("click","#cb-content > li",function(){t(this)});$(this.options.source).on("click","#cb-source > li",$.proxy(function(e){e.stopPropagation();this.add($(e.target).closest("li").data("name"));cobler.changed=true;this.trigger("change")},this))}var u=null;$("#cb-source").sortable({connectWith:"#cb-content",forcePlaceholderSize:true,helper:function(e,t){t.clone().addClass("inUse").css({height:t.outerHeight(),width:t.outerWidth()}).insertAfter(t);return t},placeholder:"cb-placeholder source",stop:$.proxy(function(e,n){if($(n.item).parent().attr("id")=="cb-source"){$(e.target).sortable("cancel");$(".inUse").remove()}else{var r=new(cobler.types[$(n.item).data("name")])(this);if(r.validate(r.attributes,false)){this.slices.splice($(n.item).index(),0,r);cobler.changed=true;this.trigger("change");$(".inUse").removeClass("inUse");var i=$(r.createEL());$(n.item).replaceWith(i);t(i.hide().show("highlight"));$("#cb-starter").hide()}else{$(e.target).sortable("cancel");$(".inUse").remove()}}},this)});window.onbeforeunload=function(){if(cobler.changed){return"Any changes that you made will be lost."}};$(this.options.source).on("click","#showwidgets",$.proxy(function(e){this.deselect()},this));this.on("editComplete",function(){$("#showwidgets, .panel-heading").hide();$("#cb-source").show()});this.on("edit",function(){$("#showwidgets, .panel-heading").show();$("#cb-source").hide()});cobler.instances[this.options.name]=this}cobler.register=function(e){cobler.types[e.type]=cobler.slice.extend(e);if($("#cb-source").length>0){for(var t in cobler.instances){cobler.instances[t].addTypeDisplay(e)}}};cobler.types={};cobler.slice=function(e,t){this.owner=e;this.attributes={};$.extend(true,this.attributes,this.defaults,t,{widgetType:this.type});this.uuid=Berry.getUID()};$.extend(cobler.slice.prototype,{createEL:function(){if(cb.options.editable){this.$el=$(Berry.render("cobler_element_cobler",this))}else{this.$el=$(Berry.render("cobler_element_cobler_noedit",this))}this.$el.find(".cobler-li-content").append(this.toHTML());return this.$el},validate:function(){return true},remove:function(){},blur:function(){},fields:[],toFORM:function(){return{label:this.display,options:{inline:false},renderer:"tabs",tabsTarget:$("#alt-sidebar .panel-heading"),actions:false,attributes:this.attributes,items:[],fields:this.fields}},toJSON:function(){this.attributes=$.extend(this.attributes,this.owner.form.toJSON());return this.attributes},toHTML:function(e){if(typeof this.template!=="undefined"){if(typeof this.template==="string"){return Berry.render(this.template,this.attributes)}else{return Berry.render(this.template(),this.attributes)}}return $("<div/>")}});cobler.instances={};cobler.slice.extend=Berry.field.extend;cobler.prototype.events={initialize:[]};cobler.prototype.addSub=Berry.prototype.addSub;cobler.prototype.on=Berry.prototype.on;cobler.prototype.off=Berry.prototype.off;cobler.prototype.trigger=Berry.prototype.trigger;cobler.changed=false;$("body").keydown(function(e){switch(e.keyCode){case 27:cb.deselect();break}})